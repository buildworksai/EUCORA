# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2025 BuildWorks.AI

name: Code Quality & Compliance

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  spdx-compliance:
    name: SPDX License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell
        run: |
          if ! command -v pwsh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https software-properties-common lsb-release
            wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb || true
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Check SPDX Headers
        run: |
          if [ ! -f "scripts/utilities/Add-SPDXHeaders.ps1" ]; then
            echo "‚ùå SPDX script not found at scripts/utilities/Add-SPDXHeaders.ps1"
            exit 1
          fi
          pwsh -File scripts/utilities/Add-SPDXHeaders.ps1 -DryRun || exit 1
          echo "‚úÖ All PowerShell files have SPDX headers"

  powershell-lint:
    name: PowerShell Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell
        run: |
          if ! command -v pwsh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https software-properties-common lsb-release
            wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb || true
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Install PSScriptAnalyzer
        run: |
          pwsh -Command "
            \$ErrorActionPreference = 'Stop'
            Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber
            Write-Host '‚úÖ PSScriptAnalyzer installed successfully'
          "

      - name: Run PSScriptAnalyzer
        run: |
          pwsh -Command "
            \$ErrorActionPreference = 'Stop'
            \$results = Invoke-ScriptAnalyzer -Path . -Recurse -IncludeDefaultRules -Severity Error,Warning | Where-Object { \$_.ScriptPath -like '*.ps1' }
            if (\$results) {
              \$results | Format-Table -AutoSize
              Write-Error 'PSScriptAnalyzer found issues'
              exit 1
            }
            Write-Host '‚úÖ PSScriptAnalyzer passed with zero errors/warnings'
          "

  file-quality:
    name: File Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          if grep -r --include="*.ps1" --include="*.md" --include="*.json" -n "[[:space:]]$" .; then
            echo "‚ùå Files with trailing whitespace found"
            exit 1
          fi
          echo "‚úÖ No trailing whitespace"

      - name: Check for large files
        run: |
          large_files=$(find . -type f -size +5M -not -path "*/node_modules/*" -not -path "*/.git/*")
          if [ -n "$large_files" ]; then
            echo "‚ùå Large files found:"
            echo "$large_files"
            exit 1
          fi
          echo "‚úÖ No large files"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -not -path "*/node_modules/*"); do
            if ! jq empty "$file" 2>/dev/null; then
              echo "‚ùå Invalid JSON: $file"
              exit 1
            fi
          done
          echo "‚úÖ All JSON files valid"

      - name: Validate YAML files
        run: |
          pip install pyyaml
          for file in $(find . -name "*.yaml" -o -name "*.yml" -not -path "*/node_modules/*"); do
            if ! python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "‚ùå Invalid YAML: $file"
              exit 1
            fi
          done
          echo "‚úÖ All YAML files valid"

  branding-compliance:
    name: Branding Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for old branding references
        run: |
          if grep -r --include="*.md" --include="*.ps1" -i "desktop-app-packaging" . --exclude-dir=".git" --exclude-dir="reports" --exclude="CHANGELOG.md"; then
            echo "‚ùå Old branding references found"
            exit 1
          fi
          echo "‚úÖ No old branding references"

      - name: Verify EUCORA branding
        run: |
          if ! grep -q "EUCORA" README.md; then
            echo "‚ùå README.md missing EUCORA branding"
            exit 1
          fi
          echo "‚úÖ EUCORA branding present"

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [spdx-compliance, powershell-lint, file-quality, branding-compliance]
    
    steps:
      - name: Report Success
        run: |
          echo "üéâ All quality checks passed!"
          echo "‚úÖ SPDX Compliance"
          echo "‚úÖ PowerShell Linting"
          echo "‚úÖ File Quality"
          echo "‚úÖ Branding Compliance"
