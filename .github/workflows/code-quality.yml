# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2025 BuildWorks.AI

name: Code Quality & Compliance

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  spdx-compliance:
    name: SPDX License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell
        run: |
          if ! command -v pwsh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https software-properties-common lsb-release
            wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb || true
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Check SPDX Headers
        run: |
          if [ ! -f "scripts/utilities/Add-SPDXHeaders.ps1" ]; then
            echo "âŒ SPDX script not found at scripts/utilities/Add-SPDXHeaders.ps1"
            exit 1
          fi
          pwsh -File scripts/utilities/Add-SPDXHeaders.ps1 -DryRun || exit 1
          echo "âœ… All PowerShell files have SPDX headers"

  powershell-lint:
    name: PowerShell Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell
        run: |
          if ! command -v pwsh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https software-properties-common lsb-release
            wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb || true
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Install PSScriptAnalyzer
        run: |
          pwsh -Command "
            \$ErrorActionPreference = 'Stop'
            Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -AllowClobber
            Write-Host 'âœ… PSScriptAnalyzer installed successfully'
          "

      - name: Run PSScriptAnalyzer
        run: |
          pwsh -Command "
            \$ErrorActionPreference = 'Stop'
            # Exclude false positives for comment-based help (.PARAMETER Type/Error flagged as aliases)
            # These are parameter names in help documentation, not actual aliases
            \$allResults = Invoke-ScriptAnalyzer -Path . -Recurse -IncludeDefaultRules -Severity Error,Warning | Where-Object { \$_.ScriptPath -like '*.ps1' }
            \$results = \$allResults | Where-Object {
              \$exclude = \$false
            # Exclude false positive: .PARAMETER Type/Error in comment-based help (not actual aliases)
            if (\$_.RuleName -eq 'PSAvoidUsingCmdletAliases' -and \$_.Line -in @(9, 10, 11, 12, 15, 17) -and (\$_.ScriptPath -like '*Write-ErrorMessage.ps1' -or \$_.ScriptPath -like '*Get-CorrelationId.ps1')) {
              \$exclude = \$true
            }
              -not \$exclude
            }
            if (\$results) {
              \$results | Format-Table -AutoSize
              Write-Error 'PSScriptAnalyzer found issues'
              exit 1
            }
            Write-Host 'âœ… PSScriptAnalyzer passed with zero errors/warnings'
          "

  file-quality:
    name: File Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          if grep -r --include="*.ps1" --include="*.md" --include="*.json" -n "[[:space:]]$" .; then
            echo "âŒ Files with trailing whitespace found"
            exit 1
          fi
          echo "âœ… No trailing whitespace"

      - name: Check for large files
        run: |
          large_files=$(find . -type f -size +5M -not -path "*/node_modules/*" -not -path "*/.git/*")
          if [ -n "$large_files" ]; then
            echo "âŒ Large files found:"
            echo "$large_files"
            exit 1
          fi
          echo "âœ… No large files"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON files
        run: |
          for file in $(find . -name "*.json" -not -path "*/node_modules/*" -not -name "tsconfig*.json" -not -name "tsconfig.*.json"); do
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON: $file"
              exit 1
            fi
          done
          echo "âœ… All JSON files valid (excluding TypeScript config files which use JSONC)"

      - name: Validate YAML files
        run: |
          pip install pyyaml
          for file in $(find . -name "*.yaml" -o -name "*.yml" -not -path "*/node_modules/*"); do
            if ! python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
              echo "âŒ Invalid YAML: $file"
              exit 1
            fi
          done
          echo "âœ… All YAML files valid"

  branding-compliance:
    name: Branding Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for old branding references
        run: |
          if grep -r --include="*.md" --include="*.ps1" -i "desktop-app-packaging" . --exclude-dir=".git" --exclude-dir="reports" --exclude="CHANGELOG.md"; then
            echo "âŒ Old branding references found"
            exit 1
          fi
          echo "âœ… No old branding references"

      - name: Verify EUCORA branding
        run: |
          if ! grep -q "EUCORA" README.md; then
            echo "âŒ README.md missing EUCORA branding"
            exit 1
          fi
          echo "âœ… EUCORA branding present"

  backend-tests:
    name: Backend Tests & Coverage
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: eucora_test
          POSTGRES_USER: eucora_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements/development.txt

      - name: Run pytest with coverage
        env:
          POSTGRES_DB: eucora_test
          POSTGRES_USER: eucora_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          DJANGO_SETTINGS_MODULE: config.settings.development
          DEBUG: 'False'
        run: |
          cd backend
          pytest --cov=apps --cov-report=xml --cov-report=term --cov-fail-under=90 -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

  frontend-lint:
    name: Frontend Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Check TypeScript compilation
        run: |
          cd frontend
          npm run build

  frontend-tests:
    name: Frontend Tests & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests with coverage
        run: |
          cd frontend
          npm run test:ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage

  summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [spdx-compliance, powershell-lint, file-quality, branding-compliance, backend-tests, frontend-lint, frontend-tests]

    steps:
      - name: Report Success
        run: |
          echo "ðŸŽ‰ All quality checks passed!"
          echo "âœ… SPDX Compliance"
          echo "âœ… PowerShell Linting"
          echo "âœ… File Quality"
          echo "âœ… Branding Compliance"
          echo "âœ… Backend Tests (â‰¥90% coverage)"
          echo "âœ… Frontend Linting"
          echo "âœ… Frontend Tests (â‰¥90% coverage)"
