# SPDX-License-Identifier: Apache-2.0
# Copyright (c) 2026 BuildWorks.AI
"""
Vulnerability scanner integration service (Trivy/Grype/Snyk).

Handles CLI-based vulnerability scanning in packaging pipelines.
"""
import subprocess
import json
import logging
from typing import Dict, List, Any, Optional
from apps.integrations.models import ExternalSystem
from apps.integrations.services.base import IntegrationService

logger = logging.getLogger(__name__)


class VulnerabilityScannerService(IntegrationService):
    """Base class for vulnerability scanner services."""
    
    def test_connection(self, config: Dict[str, Any]) -> Dict[str, Any]:
        """Test scanner CLI availability."""
        scanner_command = self._get_scanner_command()
        
        try:
            result = subprocess.run(
                [scanner_command, '--version'],
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode == 0:
                return {
                    'status': 'success',
                    'message': f'Scanner available: {result.stdout.strip()}',
                }
            else:
                return {
                    'status': 'failed',
                    'message': f'Scanner not available: {result.stderr}',
                }
        except FileNotFoundError:
            return {
                'status': 'failed',
                'message': f'Scanner command not found: {scanner_command}',
            }
        except Exception as e:
            logger.error(f'Scanner connection test failed: {e}')
            return {
                'status': 'failed',
                'message': f'Connection failed: {str(e)}'
            }
    
    def sync(self, system: ExternalSystem) -> Dict[str, Any]:
        """Scanners don't sync - they scan artifacts."""
        return {
            'fetched': 0,
            'created': 0,
            'updated': 0,
            'failed': 0,
        }
    
    def fetch_assets(self, system: ExternalSystem) -> List[Dict[str, Any]]:
        """Scanners don't fetch assets."""
        return []
    
    def scan_artifact(
        self,
        system: ExternalSystem,
        artifact_path: str,
        output_format: str = 'json'
    ) -> Dict[str, Any]:
        """
        Scan an artifact for vulnerabilities.
        
        Args:
            system: ExternalSystem instance
            artifact_path: Path to artifact file
            output_format: Output format (json, table, etc.)
        
        Returns:
            Dict with scan results including vulnerabilities
        """
        scanner_command = self._get_scanner_command()
        scan_args = self._get_scan_args(artifact_path, output_format)
        
        try:
            result = subprocess.run(
                [scanner_command] + scan_args,
                capture_output=True,
                text=True,
                timeout=300  # 5 minutes max
            )
            
            if result.returncode == 0:
                if output_format == 'json':
                    scan_results = json.loads(result.stdout)
                else:
                    scan_results = {'output': result.stdout}
                
                return {
                    'status': 'success',
                    'results': scan_results,
                    'vulnerabilities': self._extract_vulnerabilities(scan_results),
                }
            else:
                return {
                    'status': 'failed',
                    'message': result.stderr,
                }
        except subprocess.TimeoutExpired:
            return {
                'status': 'failed',
                'message': 'Scan timeout exceeded',
            }
        except Exception as e:
            logger.error(f'Scan failed: {e}')
            return {
                'status': 'failed',
                'message': str(e),
            }
    
    def _get_scanner_command(self) -> str:
        """Get scanner CLI command name."""
        raise NotImplementedError
    
    def _get_scan_args(self, artifact_path: str, output_format: str) -> List[str]:
        """Get scanner-specific command arguments."""
        raise NotImplementedError
    
    def _extract_vulnerabilities(self, scan_results: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract vulnerability list from scan results."""
        raise NotImplementedError


class TrivyService(VulnerabilityScannerService):
    """Trivy vulnerability scanner service."""
    
    def _get_scanner_command(self) -> str:
        return 'trivy'
    
    def _get_scan_args(self, artifact_path: str, output_format: str) -> List[str]:
        args = ['--format', output_format, '--no-progress', artifact_path]
        if output_format == 'json':
            args.insert(0, '--quiet')
        return args
    
    def _extract_vulnerabilities(self, scan_results: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract vulnerabilities from Trivy JSON output."""
        vulnerabilities = []
        for result in scan_results.get('Results', []):
            for vuln in result.get('Vulnerabilities', []):
                vulnerabilities.append({
                    'id': vuln.get('VulnerabilityID'),
                    'severity': vuln.get('Severity'),
                    'package': vuln.get('PkgName'),
                    'installed_version': vuln.get('InstalledVersion'),
                    'fixed_version': vuln.get('FixedVersion'),
                    'title': vuln.get('Title'),
                    'description': vuln.get('Description'),
                })
        return vulnerabilities


class GrypeService(VulnerabilityScannerService):
    """Grype vulnerability scanner service."""
    
    def _get_scanner_command(self) -> str:
        return 'grype'
    
    def _get_scan_args(self, artifact_path: str, output_format: str) -> List[str]:
        return ['--output', output_format, artifact_path]
    
    def _extract_vulnerabilities(self, scan_results: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract vulnerabilities from Grype JSON output."""
        vulnerabilities = []
        for match in scan_results.get('matches', []):
            vuln = match.get('vulnerability', {})
            vulnerabilities.append({
                'id': vuln.get('id'),
                'severity': vuln.get('severity'),
                'package': match.get('artifact', {}).get('name'),
                'installed_version': match.get('artifact', {}).get('version'),
                'fixed_version': match.get('fix', {}).get('versions', [None])[0] if match.get('fix') else None,
                'title': vuln.get('description'),
                'description': vuln.get('description'),
            })
        return vulnerabilities


class SnykService(VulnerabilityScannerService):
    """Snyk vulnerability scanner service."""
    
    def _get_scanner_command(self) -> str:
        return 'snyk'
    
    def _get_scan_args(self, artifact_path: str, output_format: str) -> List[str]:
        return ['test', '--json', artifact_path]
    
    def _extract_vulnerabilities(self, scan_results: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Extract vulnerabilities from Snyk JSON output."""
        vulnerabilities = []
        for vuln in scan_results.get('vulnerabilities', []):
            vulnerabilities.append({
                'id': vuln.get('id'),
                'severity': vuln.get('severity'),
                'package': vuln.get('package'),
                'installed_version': vuln.get('version'),
                'fixed_version': vuln.get('upgradePath', [None])[-1] if vuln.get('upgradePath') else None,
                'title': vuln.get('title'),
                'description': vuln.get('description'),
            })
        return vulnerabilities


